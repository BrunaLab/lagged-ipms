---
title: "Context-dependent consequences of including lagged effects in demographic models"
shorttitle: "Lagged Effects IPMs"
author:
  - Eric R. Scott:
      email: scottericr@gmail.com
      institute: [UF_WEC]
      correspondence: true
  - Emilio M. Bruna:
      email: embruna@ufl.edu
      institute: [UF_WEC, UF_LAS, BDFFP]
      correspondence: false
      
institute:
  - UF_WEC: Department of Wildlife Ecology and Conservation, University of Florida, Gainesville, Florida 32611-0430
  - UF_LAS: Center for Latin American Studies, University of Florida, Gainesville, Florida 32611-5530  
  - BDFFP: Biological Dynamics of Forest Fragments Project, INPA-PDBFF, CP 478, Manaus, Amazonas 69011-970 Brazil
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      linenumbers: yes
      number_sections: no
      fig_caption: yes
      reference_docx: "templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=templates/scholarly-metadata.lua
      - --lua-filter=templates/author-info-blocks.lua
      #- -Fpandoc-crossref #required for cross-ref equations
    bookdown::html_document2: 
      theme: 
        version: 4
        bootswatch: journal
      number_sections: no
      fig_caption: yes
      pandoc_args:
      - --lua-filter=templates/scholarly-metadata.lua
      - --lua-filter=templates/author-info-blocks.lua
linkcolor: blue
bibliography: references.bib
csl: "templates/the-american-naturalist.csl" # Insert path for the bib-style
keywords: |
  integral projection models; environmental stochasticity; lagged effects
highlights: |
  These are the highlights
  
editor_options:
  markdown:
    wrap: sentence
    canonical: true
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

Keywords: `r rmarkdown::metadata$keywords`

Running title: `r rmarkdown::metadata$shorttitle`

<!-- Highlights: `r rmarkdown::metadata$highlights` -->

<!-- The following code chunk defines some general settings how code chunks should behave. -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	fig.path = "figures/",
	dev = "png",
	dpi = 300,
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	comment = "#>"
)
library(targets)
library(tidyverse)
```

<!-- The actual document text starts here: -->

\pagebreak

# Abstract

Abstract text.

\pagebreak

# Introduction

1.  Demographic models are widely used for all kinds of stuff

2.  It has long been recognized that there is the potential for lagged effects.
    Now there's evidence for that [@eversLaggedDormantSeason2021; @scottDelayedEffectsClimate2022].

3.  Lagged effects could be different in different habitat types (and this could be a big reason for differences between habitats)

# Methods

## Demographic Data

## Modeling vital rates

\<!-
-# TODO:

-   Add paragraph about why we used IPMs or why a General IPM---depends on what goes in introduction maybe?

-   Add info about additional datasets (Emilio)

--\>

Why general IPM necessary?

-   Seedlings physiologically different from 1-shoot small plants because of lack of underground reserves (of carbs and meristems)

-   Seedling survival not well predicted when included with mature plants.

------------------------------------------------------------------------

### Kernel equation and description

Below is a description of the *basic*, deterministic IPM.
This maybe goes in a supplement?
These vital rates get swapped out for ones that vary by year (for the stochastic, kernel resampled IPMs) or ones that include lagged effects of SPEI (for the stochastic, parameter resampled IPMs).
See Figure \@ref(fig:lifecycle).

For mature plants:

$$
n(z^{\prime},t+1) = s_s G_s(z^\prime)n_s(t) + \int_L^U s(z) G(z^{\prime}, z) n(z,t)\;dz
$$

The number and size of mature plants in the next census is determined by seedlings entering the mature plant population (i.e. recruitment <!--# *Is* this recruitment? -->) and survival and growth (or regression) of mature plants.
Seedlings survive ($s_s$) and grow into mature plants of a particular size ($G_s(z^\prime)$).
Mature plants survive as a function of size ($s(z)$), and grow (or regress) to a new size as a function of their previous size ($G(z^\prime, z)$).

For seedlings:

$$
n_s(t+1) = \int_L^U p_f(z)f(z)g n(z,t) \; dz
$$

Mature plants flower with a probability that is a function of size ($p_f(z)$) and produce a number of seeds as a function of size ($f(z)$).
Those seeds then germinate and establish as seedlings with probability $g$.

------------------------------------------------------------------------

Ultimately, we built and iterated three types of IPMs which each required different underlying vital rate model structure (Figure \@ref(fig:lifecycle)).
For all models, we used the long term demographic dataset for modeling survival, growth, and flowering.
For established plants, these three vital rates were modeled as a smooth function of size in the previous census using generalized additive models (GAMs) fit with the `mgcv` package[@mgcv] in `r version$version.string` [@rcoreteam2020].
Seedlings were considered a separate discrete class not structured by size.
For consistency, seedling survival and growth were also modeled using GAMs, but without size in the previous census as a predictor (i.e. intercept only models).
For growth models, a scaled t family distribution provided a better fit to the data than a gaussian fit as the residuals were leptokurtic with a simple gaussian model.

To estimate reproduction we drew on additional data sources to estimate the number of fruits per flowering plant as a function of plant size, the number of seeds per fruit, and germination and establishment rates in continuous forest and forest fragments.
<!--# Emilio: add more info here -->

These models were used to build a general, density-independent, deterministic IPM with four sub-kernels: growth and survival, reproduction, probability of staying a seedling, and seedling survival and establishment.
<!--# include equation --> The probability of staying a seedling, was always equal to zero, since our definition of seedlings was first year plants only.

For the second approach, we included environmental stochasticity by adding a random effect of year to all vital rate models built with the long term demographic dataset.
The random effect of year was fit using a factor--smooth interaction which allowed the relationship between plant size and vital rates to vary in functional form among transition years.
Then, we used these models to build general, density independent, stochastic, kernel-resampled IPMs.
The kernel-resampling approach is to generate kernels corresponding to each transition year in the demographic dataset using the random smooths for year, and to iterate the IPM by drawing from these randomly.
This is equivalent to the matrix selection approach for matrix population models described by @caswell2001.

For the third method, we modeled the impacts of drought on vital rates explicitly.
We calculated the standardized precipitation evapotranspiraton index (SPEI) for our site using a published gridded dataset based on ground measurements [@xavierDailyGriddedMeteorological2016] as described in @scottDelayedEffectsClimate2022. We modeled delayed effects of SPEI on survival, growth, and flowering probability using distributed lag non-linear models fit as two dimensional tensor product splines, with a maximum lag of 36 months [@scottDelayedEffectsClimate2022].
Then these models were incorporated into a general, density independent, stochastic, parameter-resampled IPM (*sensu* @metcalfStatisticalModellingAnnual2015).
To iterate such an IPM, a random sequence of SPEI values is created by sampling years of the observed monthly SPEI data.
Then, 36 month lags are calculated for each year starting in February (the month of the demographic census).
These values are then used to predict fitted values from the vital rates models, generating different kernels at each iteration of the IPM.
With this method, the kernels of successive iterations are not entirely independent because the SPEI values used in calculating vital rates include values used in the previous two iterations.

All IPMs were constructed and iterated <!--# optimized in notes/optimizing-meshpoints.Rmd which could be turned into supplemental -->using the `ipmr` package in R [@levinIpmrFlexibleImplementation2021].
The IPMs used 100 meshpoints and the midpoint rule for calculating kernels <!--# citation? -->.
For each type of IPM we iterated the model for 1000 time steps, discarding the first 100 time steps to omit transient effects.
Stochastic growth rates ($\lambda_s$) were calculated as the average $ln(\lambda)$ from each time step [@caswell2001] and back-transformed to be on the same scale as deterministic lambdas for comparison.
We used the distribution of established plant sizes and proportion of seedlings from the full dataset as a starting population vector.
While other starting population vectors were possible, the choice is of little importance as it will only impact transient dynamics, which we aren't interested in for this study.

To calculate 95% confidence intervals around the per-capita growth rates (lambdas), we created 500 bootstraps of the demographic dataset by sampling individual plants with replacement within each habitat.
For each bootstrap, we then re-fit vital rates models (all except germination and establishment rate, fruits per flowering plant, and seeds per fruit, which were estimated using different datasets), constructed IPMs, and calculated a value for lambda as described above.
<!--# then calculated bias corrected 95% CIs -->

This workflow was managed using the `targets` R package [@targets] which also allowed us to track computational time spent on each IPM for comparison.

# Results

For all vital rates estimated using the long term demographic dataset, the DLNM model fit the best (dAIC = 0) followed by the model with a random effect of year, followed by the deterministic model (Table \@ref(tab:aic)).
<!--# No longer true if random effect = different smooth for each year -->

Population growth rates were consistently higher in continuous forest compared to forest fragments across IPM types (Table \@ref(tab:lambdas)).

The time to iterate the DLNM models is much higher than than deterministic and kernel-resampled.
The greater use of computational resources is likely a result of `predict()` being much slower for GAMs with 2D smooths because the number of knots is much higher compared to the GAMs used for the vital rates models in the determinsitic and kernel-resampled IPMs.
<!--# also note that this can't really be paralellized because each iteration depends on the previous one.  There's *maybe* some potential speed gains in using multiple cores with predict.bam(), but unlikely to be substantial. -->

```{r}
meta_df <- 
  tar_meta() %>% 
  select(name, size, bytes, time, seconds) %>% 
  filter(str_detect(name, "^ipm_\\w+_[cf]{2}$")) %>% 
  mutate(minutes = seconds / 60,
         hours = minutes / 60)

meta_df %>% 
  separate(name, into = c("trash", "IPM", "Habitat")) %>% 
  select(-trash) %>% 
  select(IPM, Habitat, minutes) %>% 
  group_by(IPM) %>% 
  summarize(mean_time_min = round(mean(minutes), 2))
```

# Discussion

-   Our finding that the choice of IPM didn't change the relative ranking of CF and FF is consistent with @kayeEffectStochasticTechnique2003 finding that method effected stochastic lambda, but relative ranking of populations was consistent.

# Acknowledgments

We thank **,** \_, \_\_\_ and \_\_\_ anonymous reviewers for helpful discussions and comments on the manuscript.
We thank Sam Levin for his help with the `ipmr` package.
Financial support was provided by the U.S.
National Science Foundation (awards \_\_\_\_, and \_\_\_\_).
The authors declare no conflicts of interest.

# CRediT Statement

<!--# https://casrai.org/credit/ -->

ERS contributed to the conceptualization, methodology, formal analysis, and led the writing of the original draft.
EMB contributed to the conceptualization, methodology, and writing and also acquired funding.

# Data Availability Statement

Data and R code used in this study are archived with Zenodo at <doi url>.

\pagebreak

# Tables

```{r}
library(pander)
```

<!--# Note: The old version of this table where "random effect of year" only meant a random intercept has DLNM *always* winning as best fit model.  Should other ways of fitting random effects be included for this table (even if not in the IPMs)?  Could add simple GLMMs, for example. -->

```{r aic, results='asis'}
pandoc.table(
  tar_read(aic_tbl_df),
  justify = c("left", "left", "left", "right", "right", "right"),
  full_width = FALSE,
  caption = "(\\#tab:aic) Comparison of vital rate models for deterministic, stochastic kernel-resampled, and stochastic parameter-resampled IPMs. 'edf' is the estimated degrees of freedom of the penalized GAM."
)
```

```{r lambdas, results='asis'}
pandoc.table(
  tar_read(lambda_table),
  digits = 5,
  keep.trailing.zeros = TRUE,
  justify = c("left", "left", "right", "right", "right"),
  full_width = FALSE,
  caption = "(\\#tab:lambda) Population growth rates for continuous forest (cf) and forest fragments (ff) under different kinds of IPMs with bootstrapped, bias-corrected, 95% confidence intervals."
)

```

# Figures

```{r}
#| lifecycle
#| fig.cap = "Diagram of IPMs with equations"

# Draft of this figure is in docs/figures/Heliconia lifecycle DAG.key
knitr::include_graphics(here::here("docs", "figures", "lifecycle.png"))
```

Combine above figure with this table:

| Description                                  | Deterministic    | Stochastic, kernel-resampled | Stochastic, parameter-resampled (DLNM) |
|----------------------|----------------|----------------|-------------------|
| Mature plant survival                        | $s(z)$           | $s_y(z)$                     | $s(z;\theta_{0-36})$                   |
| Seedling survival                            | $s_0$            | $s_{0_y}$                    | $s_0(\theta_{0-36})$                   |
| Mature plant growth or regression            | $G(z^\prime, z)$ | $G_y(z^\prime,z)$            | $G(z^\prime,z;\theta_{0-36})$          |
| Seedling growth into mature plant            | $G_0(z^\prime)$  | $G_{0_y}(z^\prime)$          | $G(z^\prime;\theta_{0-36})$            |
| Probability of flowering                     | $p_f(z)$         | $p_{f_y}(z)$                 | $p_f(z;\theta_{0-36})$                 |
| Size-specific fecundity                      | $f(z)$           | $f(z)$                       | $f(z)$                                 |
| Probability of germination and establishment | $g$              | $g$                          | $g$                                    |

<!--# probably can't make the figure with the table in it in R easily. -->

\
\
Just playing with something here.
This is the population trajectories from the iterated IPMs with `normalize_pop_size=FALSE`.
I thought maybe I'd be able to see some (lagged) similarities between the kernel sampled and DLNM IPMs because they are run with the same sequence of years.
Nothing obvious pops out.
Not sure this figure is worth including.

```{r eval=FALSE}
#| pva,
#| fig.cap = "Population trajectories for all three IPMs in both habitats"
tar_load(c(
  ipm_det_cf,
  ipm_det_ff,
  ipm_stoch_cf,
  ipm_stoch_ff,
  ipm_dlnm_cf,
  ipm_dlnm_ff
))

ipm_list <- 
  list(det_cf = ipm_det_cf,
       det_ff = ipm_det_ff,
       stoch_cf = ipm_stoch_cf,
       stoch_ff = ipm_stoch_ff,
       dlnm_cf = ipm_dlnm_cf,
       dlnm_ff = ipm_dlnm_ff)

plot_df <- 
  ipm_list %>% map_df(~{
  pop_states <- pop_state(.x)

    lapply(pop_states, colSums) %>%
    as_tibble() %>% 
    mutate(n = n_log_size + n_sdlg,
           t = 1:n())
}, .id = "model") %>% 
  separate(model, into = c("ipm", "habitat"))

p <- ggplot(plot_df, aes(x = t, y = n, color = ipm)) +
  geom_line() +
  facet_wrap(~habitat, ncol = 1)

p + xlim(10, 250)

p+ scale_y_log10() + labs(y = "log10(n)")


```

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::
