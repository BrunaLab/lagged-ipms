---
title: "Context-dependent consequences of including lagged effects in demographic models"
shorttitle: "Lagged Effects IPMs"
author:
  - Eric R. Scott:
      email: scottericr@gmail.com
      institute: [UF_WEC]
      correspondence: true
  - Emilio M. Bruna:
      email: embruna@ufl.edu
      institute: [UF_WEC, UF_LAS, BDFFP]
      correspondence: false
      
institute:
  - UF_WEC: Department of Wildlife Ecology and Conservation, University of Florida, Gainesville, Florida 32611-0430
  - UF_LAS: Center for Latin American Studies, University of Florida, Gainesville, Florida 32611-5530  
  - BDFFP: Biological Dynamics of Forest Fragments Project, INPA-PDBFF, CP 478, Manaus, Amazonas 69011-970 Brazil
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      linenumbers: yes
      number_sections: no
      fig_caption: yes
      reference_docx: "templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=templates/scholarly-metadata.lua
      - --lua-filter=templates/author-info-blocks.lua
      #- -Fpandoc-crossref #required for cross-ref equations
linkcolor: blue
bibliography: references.bib
csl: "templates/the-american-naturalist.csl" # Insert path for the bib-style
keywords: |
  keyword1; keyword2; keyword3
highlights: |
  These are the highlights
  
editor_options:
  markdown:
    wrap: sentence
    canonical: true
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

Keywords: `r rmarkdown::metadata$keywords`

Running title: `r rmarkdown::metadata$shorttitle`

<!-- Highlights: `r rmarkdown::metadata$highlights` -->

<!-- The following code chunk defines some general settings how code chunks should behave. -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	fig.path = "figures/",
	dev = "png",
	dpi = 300,
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	comment = "#>"
)
library(targets)
```

<!-- The actual document text starts here: -->

\pagebreak

# Abstract

Abstract text.

\pagebreak

# Introduction

1.  Demographic models are widely used for all kinds of stuff

2.  It has long been recognized that there is the potential for lagged effects.
    Now there's evidence for that [@eversLaggedDormantSeason2021; @scottDelayedEffectsClimate2022].

3.  Lagged effects could be different in different habitat types (and this could be a big reason for differences between habitats)

# Methods

## Demographic Data

## Modeling vital rates

Ultimately, we built and iterated three types of IPMs which each required different underlying vital rate model structure.
For all models, we used the long term demographic dataset for modeling survival, growth, and flowering.
For established plants, these three vital rates were modeled as a smooth function of size in the previous census using generalized additive models (GAMs) fit with the `mgcv` package[@mgcv] in R [@rcoreteam2020].
Seedlings were considered a separate discrete class not structured by size.
For consistency, seedling survival and growth were also modeled using GAMs, but without size in the previous census as a predictor.
For growth models, a scaled t family distribution provided a better fit to the data than a gaussian fit as the residuals were leptokurtic with a simple gaussian model.

To estimate reproduction we drew on additional data sources to estimate the number of fruits per flowering plant as a function of plant size, the number of seeds per fruit, and germination and establishment rates in continuous forest and forest fragments.
<!--# Emilio: add more info here -->

These models were used to build a general, density-independent, deterministic IPM with four sub-kernels: growth and survival, reproduction, probability of staying a seedling (always = 0), and seedling survival and establishment.
<!--# include equation --> The seedling bank, or probability of staying a seedling, was always equal to zero, but was required <!--# for reasons? -->.

For the second approach, we included environmental stochasticity by adding a random intercept for year to all vital rate models built with the long term demographic dataset.
Then, we used these models to build general, density independent, stochastic, kernel-resampled IPMs.
The kernel-resampling approach is to generate kernels for each year of data, using the random intercepts for year, and to iterate the IPM by drawing from these randomly.
This is equivalent to "matrix shuffling" approach in matrix population models [@caswell2001] <!--# I'm not actually sure that Caswell calls it "matrix shuffling" -->.

For the third method, we modeled the impacts of drought on vital rates explicitly.
We calculated the standardized precipitation evapotranspiraton index (SPEI) for our site using a published gridded dataset based on ground measurements [@xavierDailyGriddedMeteorological2016].
We modeled delayed effects of SPEI on survival, growth, and flowering probability using distributed lag non-linear models fit as two dimensional tensor product splines, with a maximum lag of 36 months[@scottDelayedEffectsClimate2022].
Then these models were incorporated into a general, density independent, stochastic, parameter-resampled IPM.
To iterate such an IPM, a random sequence of SPEI values is created by re-sampling the observed monthly SPEI data.
Then, 36 month lags are calculated for each year starting in February (the month of the demographic census).
These values are then used to predict fitted values from the vital rates models, generating different kernels at each iteration of the IPM.
With this method, these kernels are not entirely independent because the SPEI from the previous two iterations is included in the vital rates underlying each kernel.

All IPMs were constructed and iterated with the `ipmr` package in R [@ipmr].
We iterated all IPMs for 1000 iterations and checked for convergence of the population growth rate, lambda.
Stochastic growth rates ($\lambda_s$) were calculated as the mean of $ln(\lambda)$ from each iteration and back-transformed to be on the same scale as deterministic lambdas for comparison <!--# could replace entirely with an equation -->.
To calculate 95% confidence intervals around the growth rates, we bootstrapped plants in the 10 year demographic dataset within each habitat type 1000 times.
For each bootstrap, we then re-fit vital rates models (all except germination and establishment rate, fruits per flowering plant, and seeds per fruit, which were estimated using different datasets), constructed IPMs, and iterated them 1000 times to calculate lambda.

This workflow was managed using the `targets` R package [@targets] which also allowed us to track computational time spent on each IPM for comparison.

# Results

For all vital rates estimated using the long term demographic dataset, the DLNM model fit the best.

-   table of vital rate models.
    Which vital rate, which IPM, âˆ†AIC, model edf.

-   table of lambdas.
    2 habitats x 3 (4?) IPMs

-   figure of PVA??
    Conceptual diagram instead?

A reference to Table \@ref(tab:example-table).
A reference to Figure \@ref(fig:example-figure).

# Discussion

# Acknowledgments

We thank **,** \_, \_\_\_ and \_\_\_ anonymous reviewers for helpful discussions and comments on the manuscript.
We thank Sam Levin for his help with the `ipmr` package.
Financial support was provided by the U.S.
National Science Foundation (awards \_\_\_\_, and \_\_\_\_).
The authors declare no conflicts of interest.

# CRediT Statement

<!--# https://casrai.org/credit/ -->

# Data Availability Statement

Data and R code used in this study are archived with Zenodo at <doi url>.

\pagebreak

# Tables

```{r}
library(pander)
```

```{r example-table, results='asis'}
pandoc.table(
  head(iris),
  justify = c("right", "right", "right", "right", "left"),
  full_width = FALSE,
  caption = "(\\#tab:example-table) A table must include the table tag in order to cross-reference it correctly."
)
```

# Figures

```{r}
#| example-figure,
#| fig.cap = "A caption for an example figure. It can be long and span mutiple
#|   lines like this."
plot(cars)
```

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::
