---
title: "bootstrapping lambda"
author: "Eric Scott"
date: '2022-04-14'
output: 
  html_document: 
    df_print: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(targets)
library(tidyverse)
library(progress)
library(tictoc)
library(ipmr)
library(metRology)
library(here)
library(rsample)
source(here("packages.R"))
lapply(list.files(here("R"), full.names = TRUE), source)
conflict_prefer("filter", "dplyr")
```

```{r}
tar_load(data_full)
tar_load(data_1998)
tar_load(data_2008)
```

# Bootstrapping individuals

Bootstrapping should mirror sampling methods.
So we want to know how the data would be different if different individuals were sampled.
We probably also want to stratify by plot?

So, within each plot, get the unique `ha_id_number`s, then sample from those with replacement and use to filter the full dataset.

```{r}
# View(head(data_full))
```

```{r}
set.seed(123)
boot_ids <-
  data_full %>% 
  group_by(habitat) %>% 
  summarize(ha_id_number = unique(ha_id_number)) %>% 
  group_by(habitat) %>% 
  sample_n(n(), replace = TRUE) %>% 
  #for validation:
  mutate(unique_id = paste(ha_id_number, row_number(), sep = "-"))
boot_ids %>% arrange(ha_id_number)

boot <- inner_join(data_full, boot_ids)
length(unique(data_full$ha_id_number)) == length(unique(boot$unique_id))
```

Nice!
That works.

So now just need to map an IPM mega function that fits the vital rate models, builds the IPMs, and outputs lambda.

```{r}
ipm_det <- function(boot, vit_other, habitat) {
   vit_list_det <- c(list(
    vit_surv = surv_det(boot, habitat = habitat),
    vit_size = size_det(boot, habitat = habitat),
    vit_flwr = flwr_det(boot, habitat = habitat),
    vit_size_sdlg = size_sdlg_det(boot, habitat = habitat),
    vit_surv_sdlg = surv_sdlg_det(boot, habitat = habitat)
  ), vit_other)
  
  #make IPM
  make_proto_ipm_det(vit_list_det) %>% 
    make_ipm(iterations = 100,  #only needs 100 to converge
             normalize_pop_size = TRUE,
             usr_funs = list(get_scat_params = get_scat_params)
    ) %>% 
    #calculate lambda
    ipmr::lambda(log = FALSE)
}
```

```{r}
tar_load(vit_other_ff)
```

```{r}
ipm_det(boot, vit_other_ff, habitat = "1-ha")
```

Nice!
